import pytest
from httpx import AsyncClient

import logging
from uuid import uuid4
from datetime import datetime

from main import Task


random_task_id = str(uuid4())
localhost_url = "http://127.0.0.1:8000"


@pytest.mark.asyncio
async def test_get_tasks():
    async with AsyncClient(base_url=localhost_url) as ac:
        response = await ac.get("/tasks")
        logging.info(response.json())

        assert response.status_code == 200


@pytest.mark.asyncio
async def test_add_task():
    async with AsyncClient(base_url=localhost_url) as ac:
        task_test = Task(
            id=random_task_id,
            title="generated by test module test_main.py",
            content="test content",
            deadline=datetime.now(),
        )
        logging.info(task_test.__repr__())

        response = await ac.post("/tasks", content=task_test.json())
        logging.info(response.json())

        assert response.status_code == 200


@pytest.mark.asyncio
async def test_delete_task():
    async with AsyncClient(base_url=localhost_url) as ac:
        response = await ac.delete(f"/tasks/{random_task_id}")
        assert response.status_code == 204
